<!-- vim: sw=2 ts=2 expandtab smartindent ft=javascript
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WebGL Demo</title>
    <style> document, body { margin: 0px; padding: 0px; overflow: hidden; } </style>
  </head>

  <body>
    <canvas id="glcanvas"></canvas>
    <script>"use strict";

/* hmm ... */
const data = ({
  "data": {
    "buildings": [
      {
        "floors": [
          {
            "properties": [
              {
                "name": "elevation",
                "currentValue": 3.3500000000000005
              }
            ],
            "zones": []
          },
          {
            "properties": [],
            "zones": [
              {
                "surfaces": []
              }
            ]
          },
          {
            "properties": [
              {
                "name": "level",
                "currentValue": 0
              },
              {
                "name": "elevation",
                "currentValue": 0.2
              }
            ],
            "zones": [
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -12.780168388795403,
                            "y": -6.539407355163124
                          },
                          {
                            "x": -10.132827695249453,
                            "y": -6.539407355163124
                          },
                          {
                            "x": -10.132827695249453,
                            "y": -5.43003471321051
                          },
                          {
                            "x": -12.780168388795403,
                            "y": -5.43003471321051
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -17.638818637928146,
                            "y": 0.06337344227294801
                          },
                          {
                            "x": -17.638819068916835,
                            "y": -5.43003417725016
                          },
                          {
                            "x": -2.626835978033626,
                            "y": -5.430035355024561
                          },
                          {
                            "x": -2.6268356439850127,
                            "y": -1.172231677434357
                          },
                          {
                            "x": 1.230801299281198,
                            "y": -1.1722319800876448
                          },
                          {
                            "x": 1.230801396221269,
                            "y": 0.06337196184526163
                          },
                          {
                            "x": -0.49775605006144874,
                            "y": 0.06337209746030491
                          },
                          {
                            "x": -0.4977559410772011,
                            "y": 1.452491837767456
                          },
                          {
                            "x": -2.5469155137341217,
                            "y": 1.4524919985355367
                          },
                          {
                            "x": -2.5469156227183607,
                            "y": 0.06337225822838795
                          },
                          {
                            "x": -12.780168606993668,
                            "y": 0.06337306108460682
                          },
                          {
                            "x": -12.780168438037014,
                            "y": 2.216904559013114
                          },
                          {
                            "x": -16.050413778959797,
                            "y": 1.709264433672245
                          },
                          {
                            "x": -16.050413908089187,
                            "y": 0.06337331765367456
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -2.6268356439850127,
                            "y": -6.539407517133058
                          },
                          {
                            "x": -0.49775677638767196,
                            "y": -6.539407517133058
                          },
                          {
                            "x": -0.49775677638767196,
                            "y": -5.430035427303043
                          },
                          {
                            "x": -2.6268356439850127,
                            "y": -5.430035427303043
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -2.5469156146359,
                            "y": 3.7385063905727502
                          },
                          {
                            "x": -2.5469156384773997,
                            "y": 6.049351552935114
                          },
                          {
                            "x": -5.647919360455556,
                            "y": 6.827981372090198
                          },
                          {
                            "x": -5.64791952361278,
                            "y": 3.2713281222539354
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -2.5469153942047624,
                            "y": 0.0633736748658841
                          },
                          {
                            "x": -2.5469156146359,
                            "y": 3.7385063905727502
                          },
                          {
                            "x": -11.058287069972524,
                            "y": 2.4729343755914712
                          },
                          {
                            "x": -11.05828687069302,
                            "y": 0.06337316436151684
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -0.49775652651448604,
                            "y": 4.0375429891818975
                          },
                          {
                            "x": -0.4977566446034872,
                            "y": 0.0322281016309284
                          },
                          {
                            "x": 3.379101974322438,
                            "y": 0.03222805831270525
                          },
                          {
                            "x": 3.379102025478727,
                            "y": 4.610571356693302
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -2.5469153875852535,
                            "y": 1.4524918251183103
                          },
                          {
                            "x": -0.49775629178839675,
                            "y": 1.4524920111846997
                          },
                          {
                            "x": -0.49775652651448604,
                            "y": 4.0375429891818975
                          },
                          {
                            "x": -2.5469156146359,
                            "y": 3.7385063905727502
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": -2.6268356439850127,
                            "y": -5.430035427303043
                          },
                          {
                            "x": 1.2308012350549649,
                            "y": -5.430035427303043
                          },
                          {
                            "x": 1.2308012350549649,
                            "y": -1.172231677434357
                          },
                          {
                            "x": -2.6268356439850127,
                            "y": -1.172231677434357
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "surfaces": [
                  {
                    "shapes": [
                      {
                        "vertices": [
                          {
                            "x": 1.2308015603606057,
                            "y": -5.430035115453304
                          },
                          {
                            "x": 4.8631940768045325,
                            "y": -5.430035115453304
                          },
                          {
                            "x": 4.8631940768045325,
                            "y": 0.06337206860599433
                          },
                          {
                            "x": 1.2308015603606057,
                            "y": 0.06337206860599433
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "properties": [],
            "zones": [
              {
                "surfaces": []
              }
            ]
          }
        ]
      }
    ]
  }
}).data.buildings[0];

const ACTIVE_FLOOR = data.floors.findIndex(x => x.properties.some(p => p.name == "level" && p.currentValue == 0));

/* graphql expr does this now */
// for (const floor of data.floors) {
//   for (const zone of data.floors[ACTIVE_FLOOR].zones) {
//     zone.surfaces.sort((a, b) => Date.parse(a.lastModified) - Date.parse(b.lastModified));
// 
//     for (const surface of zone.surfaces) {
//       for (const shape of surface.shapes) {
//         shape.vertices.sort((a, b) => a.index - b.index);
//       }
//     }
//   }
// }

let input_zoom = 1;
window.onwheel = e => input_zoom += e.deltaY * 0.001;
let camera_x = 0;
let camera_y = 0;
let camera_panning = false;
window.onmousedown = () => camera_panning = true;
window.onmouseup   = () => camera_panning = false;
window.onmousemove = ev => {
  if (!camera_panning) return;
  camera_x -= ev.movementX;
  camera_y -= ev.movementY;
}

const canvas = document.getElementById("glcanvas");
const ctx = canvas.getContext('2d');
(window.onresize = () => {
   canvas.width = window.innerWidth*window.devicePixelRatio,
   canvas.height = window.innerHeight*window.devicePixelRatio
   canvas.style.width = window.innerWidth + 'px';
   canvas.style.height = window.innerHeight + 'px';
 })();

requestAnimationFrame(function render(now) {
  requestAnimationFrame(render);

  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  (() => {

    const m = mat4_create();
    mat4_mul(m, m, mat4_from_translation(mat4_create(), [-camera_x, -camera_y, 0]));
    mat4_mul(m, m, mat4_from_scaling(mat4_create(), 40*input_zoom, -40*input_zoom, 40*input_zoom));

    const p = [0, 0, 0, 1];
    const transform_p = (x, y) => {
      p[0] = x;
      p[1] = y;
      p[2] = 0;
      p[3] = 1;
      mat4_transform_vec4(p, p, m);
    }

    // ctx.scale(40*input_zoom, -40*input_zoom);

    for (const zone of data.floors[ACTIVE_FLOOR].zones) {
      for (const surface of zone.surfaces) {
        for (const shape of surface.shapes) {
          if (shape.vertices.length == 0) continue;

          ctx.beginPath();
          let i = 0;

          for (const vtx of shape.vertices) {
            transform_p(vtx.x, vtx.y);
            if (i++ == 0) ctx.moveTo(p[0], p[1]);
            else          ctx.lineTo(p[0], p[1]);
          }

          transform_p(shape.vertices[0].x, shape.vertices[0].y);
          ctx.lineTo(p[0], p[1]);

          {
            ctx.globalAlpha = 0.5;
            {
              ctx.lineWidth = 0.15 * 40 * input_zoom;
              ctx.strokeStyle = 'orange';
              ctx.stroke();
              ctx.closePath();
            }
            ctx.globalAlpha = 1.0;
          }
        }
      }
    }

  })();
  ctx.restore();
})

function mat4_create() {
    let out = new Float32Array(16);
    out[0] = 1;
    out[5] = 1;
    out[10] = 1;
    out[15] = 1;
    return out;
}

function mat4_from_scaling(out, x, y=x, z=x) {
    out[0] = x;
    out[1] = 0;
    out[2] = 0;
    out[3] = 0;
    out[4] = 0;
    out[5] = y;
    out[6] = 0;
    out[7] = 0;
    out[8] = 0;
    out[9] = 0;
    out[10] = z;
    out[11] = 0;
    out[12] = 0;
    out[13] = 0;
    out[14] = 0;
    out[15] = 1;
    return out;
}

function mat4_from_translation(out, v) {
    out[0] = 1;
    out[1] = 0;
    out[2] = 0;
    out[3] = 0;
    out[4] = 0;
    out[5] = 1;
    out[6] = 0;
    out[7] = 0;
    out[8] = 0;
    out[9] = 0;
    out[10] = 1;
    out[11] = 0;
    out[12] = v[0];
    out[13] = v[1];
    out[14] = v[2];
    out[15] = 1;
    return out;
}

function mat4_transform_vec4(out, a, m) {
    let x = a[0], y = a[1], z = a[2], w = a[3];
    out[0] = m[0] * x + m[4] * y + m[8] * z + m[12] * w;
    out[1] = m[1] * x + m[5] * y + m[9] * z + m[13] * w;
    out[2] = m[2] * x + m[6] * y + m[10] * z + m[14] * w;
    out[3] = m[3] * x + m[7] * y + m[11] * z + m[15] * w;
    return out;
}

function mat4_mul(out, a, b) {
    let a00 = a[0], a01 = a[1], a02 = a[2], a03 = a[3];
    let a10 = a[4], a11 = a[5], a12 = a[6], a13 = a[7];
    let a20 = a[8], a21 = a[9], a22 = a[10], a23 = a[11];
    let a30 = a[12], a31 = a[13], a32 = a[14], a33 = a[15];
    /* Cache only the current line of the second matrix */
    let b0 = b[0], b1 = b[1], b2 = b[2], b3 = b[3];
    out[0] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30;
    out[1] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31;
    out[2] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32;
    out[3] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33;
    b0 = b[4];
    b1 = b[5];
    b2 = b[6];
    b3 = b[7];
    out[4] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30;
    out[5] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31;
    out[6] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32;
    out[7] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33;
    b0 = b[8];
    b1 = b[9];
    b2 = b[10];
    b3 = b[11];
    out[8] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30;
    out[9] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31;
    out[10] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32;
    out[11] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33;
    b0 = b[12];
    b1 = b[13];
    b2 = b[14];
    b3 = b[15];
    out[12] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30;
    out[13] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31;
    out[14] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32;
    out[15] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33;
    return out;
}

function lerp(v0, v1, t) { return (1 - t) * v0 + t * v1; }
function inv_lerp(min, max, p) { return (p - min) / (max - min); }
    </script>
  </body>
</html>
